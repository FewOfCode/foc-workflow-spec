# Fow Of Code流程编排定义语言 - Version 0.1



## 目录

- [Fow Of Code流程编排定义语言 - Version 0.1](#fow-of-code流程编排定义语言---version-01)
  - [目录](#目录)
  - [基本介绍](#基本介绍)
  - [流程定义](#流程定义)
  - [节点定义](#节点定义)
    - [通用属性](#通用属性)
    - [变量注入节点](#变量注入节点)
    - [任务节点](#任务节点)
    - [分支节点](#分支节点)
      - [branch](#branch)
  - [关联对象属性定义](#关联对象属性定义)
    - [函数](#函数)
      - [示例一](#示例一)
      - [示例二](#示例二)
    - [异常策略](#异常策略)
      - [retry](#retry)
      - [goto](#goto)
        - [errRefs](#errrefs)
      - [exit](#exit)




## 基本介绍

foc-workflow-spec(Fow Of Code Workflow Specification)，流程编排定义语言用于描述和定义业务逻辑。



## 流程定义

| 属性名称          | 类型   | 描述                                                                                         | 是否必填 | 默认值 |
| ----------------- | ------ | -------------------------------------------------------------------------------------------- | -------- | ------ |
| id              | string | 流程定义id                                                                            | 是       ||
| version         | string | 流程定义版本                                                                      | 是       |    |
| name      | string | 流程定义名称                                     | 是       |    |
| description   | string | 流程定义描述                                                                             | 否       ||
| specVersion | string | 使用的规范版本 | 是 |0.1|
| start | string | 开始节点 | 是 ||
| expressionLang | string | 定义表达式语言 | 否       |jq|
| input | object | 流程输入变量 | 否 ||
| [nodes](#节点定义) | array | 流程节点 | 是 ||
| metadata | object | 元数据 | 否 ||



## 节点定义

节点是指定义流程执行指令的模块，节点定义了工作流在运行过程中应该执行的一组业务逻辑指令。

### 通用属性

通用属性指所有的节点所共有的属性，跟节点的类型无关。具体参考以下表格:

| 属性名称                   | 类型              | 描述                                                         | 是否必填 | 默认值 |
| -------------------------- | ----------------- | ------------------------------------------------------------ | -------- | ------ |
| id                         | string            | 节点的唯一ID                                                 | 是       |        |
| name                       | string            | 节点名称                                                     | 是       |        |
| next                       | string            | 下一个节点ID。默认为`end`，表示流程结束                      | 否       | end    |
| skip                       | boolean 或 string | 是否忽略该节点。当类型为 string 的时候，表示使用表达式计算值。 | 否       | false  |
| preDelay                   | int 或 string     | 执行前延时，单位：毫秒。当类型为 string 的时候，表示使用表达式计算值。 | 否       | 0      |
| postDelay                  | int 或 string     | 执行后延时，单位：毫秒。当类型为 string 的时候，表示使用表达式计算值。 | 否       | 0      |
| [errorStrategy](#异常策略) | object            | 定义异常策略，当节点执行发生异常的时候执行异常策略。         | 否       |        |
| type                       | enum              | 节点类型。                                                   | 否       | task   |
| metadata                   | object            | 元数据                                                       | 否       |        |

### 变量注入节点

基础属性

| 属性名称  | 类型              | 描述                                                         | 是否必填 | 默认值 |
| --------- | ----------------- | ------------------------------------------------------------ | -------- | ------ |
| id        | string            | 节点的唯一ID                                                 | 是       |        |
| name      | string            | 节点名称                                                     | 是       |        |
| next      | string            | 下一个节点ID。默认为`end`，表示流程结束                      | 否       | end    |
| skip      | boolean 或 string | 是否忽略该节点。当类型为 string 的时候，表示使用表达式计算值。 | 否       | false  |
| preDelay  | int 或 string     | 执行前延时，单位：毫秒。当类型为 string 的时候，表示使用表达式计算值。 | 否       | 0      |
| postDelay | int 或 string     | 执行后延时，单位：毫秒。当类型为 string 的时候，表示使用表达式计算值。 | 否       | 0      |
| type      | string            | 节点类型。固定值：`inject`                                   | 是       |        |
| metadata  | object            | 元数据                                                       | 否       |        |

特有属性

| 属性名称 | 类型   | 描述                                                    | 是否必填 | 默认值 |
| -------- | ------ | ------------------------------------------------------- | -------- | ------ |
| data     | object | 此数据最终会注入流程变量中，如果key存在则修改，否则新增 | 是       |        |

### 任务节点

基础属性

| 属性名称                   | 类型              | 描述                                                         | 是否必填 | 默认值 |
| -------------------------- | ----------------- | ------------------------------------------------------------ | -------- | ------ |
| id                         | string            | 节点的唯一ID                                                 | 是       |        |
| name                       | string            | 节点名称                                                     | 是       |        |
| next                       | string            | 下一个节点ID。默认为`end`，表示流程结束                      | 否       | end    |
| skip                       | boolean 或 string | 是否忽略该节点。当类型为 string 的时候，表示使用表达式计算值。 | 否       | false  |
| preDelay                   | int 或 string     | 执行前延时，单位：毫秒。当类型为 string 的时候，表示使用表达式计算值。 | 否       | 0      |
| postDelay                  | int 或 string     | 执行后延时，单位：毫秒。当类型为 string 的时候，表示使用表达式计算值。 | 否       | 0      |
| [errorStrategy](#异常策略) | object            | 定义异常策略，当节点执行发生异常的时候执行异常策略。         | 否       |        |
| type                       | string            | 节点类型。固定值：`task`                                     | 是       |        |
| metadata                   | object            | 元数据                                                       | 否       |        |

特有属性

| 属性名称           | 类型  | 描述                               | 是否必填 | 默认值 |
| ------------------ | ----- | ---------------------------------- | -------- | ------ |
| [functions](#函数) | array | 要执行的函数列表。至少包含一个函数 | 是       |        |



### 分支节点

基础属性

| 属性名称                   | 类型              | 描述                                                         | 是否必填 | 默认值 |
| -------------------------- | ----------------- | ------------------------------------------------------------ | -------- | ------ |
| id                         | string            | 节点的唯一ID                                                 | 是       |        |
| name                       | string            | 节点名称                                                     | 是       |        |
| containerId                | string            | 如果处于循环/条件/异常容器中的组件,则对应该容器的 ID         | 否       | root   |
| skip                       | boolean 或 string | 是否忽略该节点。当类型为 string 的时候，表示使用表达式计算值。 | 否       | false  |
| [errorStrategy](#异常策略) | object            | 定义异常策略，当节点执行发生异常的时候执行异常策略。         | 否       |        |
| type                       | enum              | 节点类型。固定值：`branch`                                   | 否       | branch |
| metadata                   | object            | 元数据                                                       | 否       |        |

特有属性

| 属性名称                 | 类型   | 描述                                         | 是否必填 | 默认值 |
| ------------------------ | ------ | -------------------------------------------- | -------- | ------ |
| [branchs](#branch)       | array  | 可选分支                                     | 是       |        |
| [defaultBranch](#branch) | object | 默认分支。若不满足以上分支条件，则走默认分支 | 是       |        |

#### branch

| 属性名称  | 类型   | 描述                                    | 是否必填 | 默认值 |
| --------- | ------ | --------------------------------------- | -------- | ------ |
| name      | string | 分支名称                                | 否       |        |
| condition | string | 字符串表达式。必须执行为`true`或`false` | 是       |        |
| next      | string | 下一个节点ID。默认为`end`，表示流程结束 | 否       | end    |



### 容器节点







## 关联对象属性定义

关联到节点的结构定义

### 函数

函数主要用于[任务节点](#任务节点)，通常指的是程序中的函数，即功能执行的语句块。

| 属性名称 | 类型              | 描述                                                         | 是否必填 | 默认值 |
| -------- | ----------------- | ------------------------------------------------------------ | -------- | ------ |
| name     | string            | 函数名                                                       | 是       |        |
| action   | string            | 函数调用定义，如`path/module/numberOp#add`                   | 是       |        |
| args     | object            | 函数参数列表。参数名称为`string`类型，参数值任何类型，也支持表达式。 | 否       |        |
| output   | string            | 返回值的流程变量名，若流程不存在此变量会新增，否则修改。不填表示不接收返回值 | 否       |        |
| async    | boolean           | 是否异步执行                                                 | 否       | false  |
| skip     | boolean 或 string | 是否忽略该函数的执行。当类型为 string 的时候，表示使用表达式计算值。 | 否       | false  |

#### 示例一

有返回值

```json
{
  "name": "add",
  "action": "path/module/numberOp#add",
  "args": {
    "num1": 1,
    "num2": "${ num2 }"
  },
  "output": "result",
  "async": false,
  "skip": false
}
```

#### 示例二

无返回值

```json
{
  "name": "print",
  "action": "path/module/Printer#print",
  "args": {
    "str": "${ str }"
  },
  "async": false,
  "skip": false
}
```

### 异常策略

异常策略用于当节点执行发生异常的时候，触发的行为。

| 属性名称   | 类型   | 描述                                                         | 是否必填             | 默认值 |
| ---------- | ------ | ------------------------------------------------------------ | -------------------- | ------ |
| type       | enum   | 定义异常策略类型。异常策略目前有 3 种：`retry`，`goto`，`exit` | 是                   | `exit` |
| properties | object | 异常策略参数。可以为[retry](#retry)、[goto](#goto)、[exit](#exit)其中之一 | 除了`exit`类型，其他必填 |        |

#### retry

节点发生异常时，根据参数进行重试。

| 属性名称        | 类型 | 描述     | 是否必填 | 默认值 |
| --------------- | ---- | -------- | -------- | ------ |
| interval | int  | 重试间隔，单位：毫秒 | 否       | 0      |
| retryCount      | int  | 重试次数 | 是       | 1      |

#### goto

节点发生异常时，跳转到其他节点。

| 属性名称            | 类型   | 描述                                         | 是否必填 | 默认值 |
| ------------------- | ------ | -------------------------------------------- | -------- | ------ |
| [errRefs](#errRefs) | array  | 错误关联                                     | 否       |        |
| defaultNext         | string | 默认跳转的节点 ID。默认为`end`，表示流程结束 | 否       | end    |

##### errRefs

| 属性名称 | 类型   | 描述                                                         | 是否必填 | 默认值 |
| -------- | ------ | ------------------------------------------------------------ | -------- | ------ |
| errCode  | string | 错误代码                                                     | 是       |        |
| next     | string | 若抛出的错误代码符合，则运行对应节点。默认为`end`，表示流程结束 | 否       | end    |

#### exit

节点发生异常时，直接结束流程，无参数
